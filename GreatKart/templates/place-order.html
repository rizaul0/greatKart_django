{% extends 'base_template.html' %}
{% load static %}

{% block content %}

<section class="section-content padding-y bg">
<div class="container">
<div class="row">

<!-- ============================ MAIN ============================ -->
<main class="col-md-8">

<!-- ============================ REVIEW CART ============================ -->
<article class="card mb-4">
  <div class="card-body">
    <h4 class="card-title mb-4">Review cart</h4>

    {% for cart_item in cart_items %}
    <div class="row align-items-center mb-3">
      <div class="col-12">
        <figure class="itemside d-flex align-items-center">
          <div class="aside mr-3">
            <img src="{{ cart_item.product.image.url }}" class="border img-sm">
          </div>
          <figcaption class="info">
            <p class="mb-1 font-weight-bold">
              {{ cart_item.product.product_name }}
              {% if cart_item.variation.exists %}
                â€”
                {% for variant in cart_item.variation.all %}
                  {{ variant.variant_value }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
              {% endif %}
            </p>
            <span class="text-muted">
              {{ cart_item.quantity }} Ã— â‚¹{{ cart_item.product.price }} =
              <strong>â‚¹{{ cart_item.sub_total }}</strong>
            </span>
          </figcaption>
        </figure>
      </div>
    </div>
    {% endfor %}
  </div>
</article>

<!-- ============================ CONTACT INFO ============================ -->
<article class="card mb-4">
<div class="card-body">
  <h4 class="card-title mb-4">Contact info</h4>
  <div class="row">
    <div class="form-group col-sm-6">
      <label>First name</label>
      <input type="text" class="form-control" value="{{ user.first_name }}" disabled>
    </div>
    <div class="form-group col-sm-6">
      <label>Last name</label>
      <input type="text" class="form-control" value="{{ user.last_name }}" disabled>
    </div>
    <div class="form-group col-sm-6">
      <label>Phone</label>
      <input type="text" class="form-control" value="{{ user.phone }}" disabled>
    </div>
    <div class="form-group col-sm-6">
      <label>Email</label>
      <input type="email" class="form-control" value="{{ user.email }}" disabled>
    </div>
  </div>
</div>
</article>

<!-- ============================ DELIVERY ============================ -->
<article class="card mb-4">
<div class="card-body">
  <h4 class="card-title mb-3">Delivery address</h4>

  <p><strong>{{ user.first_name }} {{ user.last_name }}</strong></p>
  <p>{{ user.house }}, {{ user.street }}</p>
  <p>{{ user.city }}, {{ user.state }}</p>
  <p>{{ user.country }} â€“ {{ user.zip }}</p>
  <p>ðŸ“ž {{ user.phone }}</p>

  <a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-primary">
    Edit address
  </a>
</div>
</article>

<!-- ============================ PAYMENT ============================ -->
<article class="card mb-4">
<div class="card-body">
  <h4 class="card-title mb-3">Payment Method</h4>

  <form method="post" id="paymentForm">
    {% csrf_token %}

    <!-- PayU -->
    <div class="form-check mb-2">
      <input class="form-check-input" type="radio" name="payment_method" id="payu" value="payu" checked>
      <label class="form-check-label" for="payu">
        <img src="{% static 'images/payu.png' %}" height="20" class="mr-2">
        Pay using PayU (UPI / Card / NetBanking)
      </label>
    </div>

    <!-- COD -->
    <div class="form-check mb-4">
      <input class="form-check-input" type="radio" name="payment_method" id="cod" value="cod">
      <label class="form-check-label" for="cod">
        <i class="fas fa-truck mr-2"></i>
        Cash on Delivery
      </label>
    </div>

    <button type="submit" class="btn btn-primary btn-block">
      Place Order
    </button>
  </form>
</div>
</article>

</main>

<!-- ============================ SUMMARY ============================ -->
<aside class="col-md-4">
<div class="card">
<div class="card-body">

  <dl class="dlist-align">
    <dt>Total price:</dt>
    <dd class="text-right">â‚¹{{ total_price }}</dd>
  </dl>

  {% if coupon and discount > 0 %}
<dl class="dlist-align">
  <dt>
    Coupon
    <small class="text-success">
      ({{ coupon.code }} â€“ {{ coupon.discount_percent }}% OFF)
    </small>
  </dt>
  <dd class="text-right text-success">
    -â‚¹{{ discount }}
  </dd>
</dl>
{% endif %}


  <dl class="dlist-align">
    <dt>Tax:</dt>
    <dd class="text-right">â‚¹{{ tax }}</dd>
  </dl>

  <dl class="dlist-align">
    <dt>Total:</dt>
    <dd class="text-right text-dark"><strong>â‚¹{{ grand_total }}</strong></dd>
  </dl>

</div>
</div>
</aside>

</div>
</div>
</section>

<!-- ============================ SCRIPT ============================ -->
<script>
  const paymentForm = document.getElementById("paymentForm");

  paymentForm.addEventListener("submit", function () {
    const method = document.querySelector(
      'input[name="payment_method"]:checked'
    ).value;

    if (method === "payu") {
      paymentForm.action = "{% url 'payu_redirect' %}";
    } else {
      paymentForm.action = "{% url 'cod_confirm' %}";
    }
  });
</script>

{% endblock %}
